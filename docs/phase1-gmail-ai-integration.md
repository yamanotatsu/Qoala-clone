# 📧🤖 Phase 1: Gmail連携 + AI解析統合 詳細計画書

## 概要
**目標**: ユーザー登録 → Gmail指定 → SESメール自動取得 → AI解析 → DB保存の完全自動化システム構築

---

## 🎯 Phase 1の戦略的重要性

### **なぜPhase 1が最重要なのか**
1. **技術リスクの集約**: Gmail API制限、AI解析精度、処理コストという3大リスクを一挙に検証
2. **早期価値提供**: 実用的な自動化システムが完成
3. **開発方針の確定**: このフェーズの成功により、残りの開発が確実性を持って進められる
4. **投資対効果**: 最も価値の高いコア機能を最短期間で実現

### **Phase 1完成時の状態**
- SESメールが10分間隔で自動取得される
- AIが70%以上の精度でメール内容を構造化データに変換
- 案件・人材情報がデータベースに自動保存される
- 基本的な管理画面でデータ確認・手動修正が可能
- 全体システムの技術的基盤が完成

---

## 📋 実装ステップ

## **ステップ1: プロジェクト基盤構築**

### **目標**
開発環境の完全構築と技術スタックの動作確認。後続ステップでの開発を効率化する基盤作り。

### **プロジェクト初期化**

#### **環境構築作業**
- **Next.js 14プロジェクト作成**: App Routerを使用した最新構成
- **TypeScript設定**: 厳密な型チェック有効化、絶対パス設定
- **ESLint + Prettier設定**: コード品質とフォーマットの統一
- **Git設定**: .gitignore設定、初期コミット、GitHub連携
- **フォルダ構成**: src/app, src/components, src/lib, src/types等の基本構造

#### **設定ファイル詳細**
- **tsconfig.json**: 厳密モード、絶対パス、型チェック強化
- **tailwind.config.js**: shadcn/ui対応、カスタムカラー設定
- **next.config.js**: 環境変数、画像最適化、セキュリティヘッダー
- **.env.local**: 開発用環境変数テンプレート作成

### **データベース基盤**

#### **Supabase + Prisma設定**
- **Supabaseプロジェクト作成**: PostgreSQLデータベースの初期設定
- **Prisma設定**: Supabase接続、スキーマ定義、クライアント生成
- **初期テーブル作成**: User, Email, Project, Engineer, Matchテーブルの基本構造
- **マイグレーション実行**: 開発環境での動作確認

#### **データベース設計の詳細検討**
- **インデックス戦略**: 検索・フィルタ性能向上のための最適化
- **JSON型活用**: AI解析結果の柔軟な保存方法
- **制約設定**: データ整合性確保のための制約定義
- **バックアップ戦略**: 開発段階からのデータ保護計画

### **認証基盤構築**

#### **NextAuth.js実装**
- **Google OAuth設定**: Google Cloud Consoleでの詳細設定
- **セッション管理**: データベースセッション vs JWTの選択
- **認証フロー**: ログイン・ログアウト・セッション維持の実装
- **ミドルウェア**: 認証が必要なページの保護設定

#### **Gmail API準備**
- **OAuth スコープ設定**: 必要最小限の権限での安全な設定
- **アクセストークン管理**: リフレッシュトークンの安全な保存
- **API接続テスト**: 基本的なメール取得動作確認
- **エラーハンドリング**: 認証失敗時の適切な処理

### **ステップ1の成果物と検証**
- **動作するNext.jsアプリケーション**: 基本レイアウトでの表示確認
- **データベース接続**: Prismaでのデータ操作確認
- **Google認証**: ログイン・ログアウトの動作確認
- **Gmail API接続**: 基本的なメール一覧取得の確認

---

## **ステップ2: 認証システム完成**

### **目標**
ユーザー認証とGmail API連携の完全実装。安全で安定した認証基盤の構築。

### **ユーザー管理システム**

#### **ユーザーデータ管理**
- **ユーザー登録フロー**: 初回ログイン時のデータベース登録
- **プロフィール管理**: ユーザー情報の表示・更新機能
- **アカウント設定**: Gmail連携状態の管理
- **セッション管理**: 長期間ログイン状態の維持

#### **Gmail連携状態管理**
- **連携ステータス**: 未連携・連携済み・エラー状態の管理
- **トークン管理**: アクセストークン・リフレッシュトークンの暗号化保存
- **権限確認**: 必要なGmailスコープの取得確認
- **再認証フロー**: トークン期限切れ時の自動再認証

### **Gmail API実装基盤**

#### **API接続ライブラリ**
- **Google APIs Node.js**: 公式SDKの設定と最適化
- **レート制限対応**: API制限を考慮した呼び出し制御
- **エラーハンドリング**: 各種エラーケースへの対応
- **ログ機能**: API呼び出しの詳細ログ記録

#### **メール取得基礎機能**
- **基本的なメール取得**: 指定期間のメール一覧取得
- **メール詳細取得**: 件名・送信者・本文の取得
- **添付ファイル処理**: 添付ファイルの有無確認
- **HTML/テキスト判定**: メール形式の判定と適切な処理

### **セキュリティ実装**

#### **セキュリティ対策**
- **CSRF保護**: Next.jsでのCSRF攻撃対策
- **XSS対策**: ユーザー入力の適切なサニタイゼーション
- **セキュアヘッダー**: セキュリティヘッダーの設定
- **環境変数暗号化**: 機密情報の安全な管理

#### **データ保護**
- **個人情報暗号化**: メールアドレス等の暗号化保存
- **アクセスログ**: セキュリティ監査のためのログ記録
- **権限制御**: ユーザーは自分のデータのみアクセス可能
- **データ削除**: ユーザーアカウント削除時の完全データ削除

### **ステップ2の成果物と検証**
- **完全な認証システム**: Google OAuth完全動作
- **Gmail API基盤**: 安定したメール取得機能
- **セキュリティ基盤**: 本番レベルのセキュリティ対策
- **ユーザー管理**: プロフィール・設定管理機能

---

## **ステップ3: Gmail API連携実装**

### **目標**
Gmail APIを使用した本格的なメール取得システムの実装。SESメール判定ロジックの構築。

### **メール取得システム**

#### **メール取得ロジック**
- **日付範囲指定**: 過去30日分の効率的な取得
- **増分取得**: 前回取得以降の新着メールのみ取得
- **バッチサイズ最適化**: API制限内での最大効率取得
- **並列処理**: 複数メールの同時処理による高速化

#### **SESメール判定システム**
- **件名パターン認識**: 「案件」「募集」「SES」等のキーワード検出
- **送信者ドメイン分析**: 企業ドメインからの信頼性判定
- **本文内容分析**: 技術スキル、単価情報の有無確認
- **除外ルール**: スパム・プロモーションメールの自動除外

### **Day 18-19: データ処理・保存**

#### **メールデータ構造化**
- **ヘッダー情報抽出**: 送信者・受信日時・件名の正規化
- **本文クリーニング**: HTMLタグ除去・署名削除・引用除去
- **文字エンコーディング**: 日本語メールの適切な処理
- **添付ファイル処理**: PDFスキルシート等の検出・保存

#### **データベース保存最適化**
- **重複チェック**: Gmail IDによる重複メール検出
- **データ正規化**: 送信者情報・件名の統一処理
- **インデックス活用**: 高速検索のためのインデックス設計
- **バッチ保存**: 複数メールの効率的な一括保存

### **Day 20-21: エラーハンドリング・監視**

#### **エラー処理システム**
- **API制限エラー**: レート制限時の適切な待機・再試行
- **認証エラー**: トークン期限切れ時の自動再認証
- **ネットワークエラー**: 一時的な接続問題への対応
- **データエラー**: 不正なメールデータの適切な処理

#### **監視・ログシステム**
- **処理状況監視**: メール取得・処理の進捗管理
- **エラーログ記録**: 詳細なエラー情報の記録・分析
- **パフォーマンス監視**: API応答時間・処理時間の測定
- **アラート機能**: 重大エラー発生時の通知機能

### **Week 3の成果物と検証**
- **安定したメール取得**: 大量メールの効率的取得
- **高精度SES判定**: 関連メールの正確な識別
- **堅牢なエラー処理**: 様々な異常ケースへの対応
- **包括的な監視**: システム状態の完全な可視化

---

## **ステップ4: バッチ処理システム構築**

### **目標**
定期的なメール取得を自動化するバッチ処理システムの構築。運用に耐える安定性の確保。

### **Day 22-24: 自動化システム設計**

#### **Vercel Cron Jobs実装**
- **スケジュール設定**: 10分間隔での確実な実行
- **タイムゾーン考慮**: 日本時間での適切なスケジューリング
- **実行時間制限**: Vercelの制限内での効率的な処理
- **同時実行制御**: 重複実行の防止メカニズム

#### **キューイングシステム**
- **処理キュー管理**: メール処理の順序制御
- **優先度制御**: 重要なメールの優先処理
- **リトライ機能**: 失敗時の自動再試行
- **デッドレターキュー**: 処理不可能なメールの隔離

### **Day 25-26: 処理最適化**

#### **パフォーマンス最適化**
- **バッチサイズ調整**: 処理効率と安定性のバランス
- **メモリ使用量最適化**: 大量データ処理時のメモリ管理
- **データベース接続管理**: 接続プールの効率的な利用
- **並列処理制御**: CPU使用率の最適化

#### **API使用量最適化**
- **クォータ管理**: 日次・時間次制限の監視
- **効率的なクエリ**: 必要最小限のデータ取得
- **キャッシュ活用**: 重複リクエストの削減
- **分散処理**: 複数ユーザーの負荷分散

### **Day 26-28: 管理画面実装**

#### **処理状況監視画面**
- **リアルタイム状況表示**: 現在の処理状況の可視化
- **処理履歴表示**: 過去の実行履歴・結果確認
- **エラー状況確認**: エラー発生状況の詳細表示
- **手動実行機能**: 必要時の手動バッチ実行

#### **メール管理画面**
- **取得メール一覧**: 処理対象メールの確認
- **処理状況表示**: pending/processing/completed/failed状態
- **詳細情報表示**: メール内容・処理結果の確認
- **手動処理機能**: 失敗メールの手動再処理

### **Week 4の成果物と検証**
- **完全自動化**: 人手を介さない継続的な処理
- **高い安定性**: 24時間365日の安定稼働
- **効率的な処理**: API制限内での最大スループット
- **包括的な管理**: 全処理状況の完全な可視化

---

## **ステップ5: AI解析エンジン基盤**

### **目標**
Google Gemini APIを活用したメール解析システムの実装。高精度な情報抽出の実現。

### **Day 29-31: AI API統合**

#### **Gemini API連携**
- **API設定**: Gemini Pro/Gemini Pro Visionの適切な使い分け
- **認証管理**: APIキーの安全な管理・ローテーション
- **レート制限対応**: API制限内での効率的な利用
- **コスト管理**: トークン使用量の監視・最適化

#### **プロンプトエンジニアリング基盤**
- **プロンプトテンプレート**: 再利用可能なプロンプト構造
- **動的プロンプト生成**: メール内容に応じた最適化
- **プロンプトバージョン管理**: A/Bテスト対応
- **結果品質評価**: 出力品質の自動評価システム

### **Day 32-33: 2段階解析実装**

#### **第1段階: 関連性判定**
- **高速判定**: Gemini Proでの効率的な判定
- **判定基準**: SES案件・人材情報の明確な判定ルール
- **信頼度スコア**: 判定結果の確信度数値化
- **除外ルール**: 明らかに無関係なメールの早期除外

#### **第2段階: 詳細情報抽出**
- **高精度抽出**: Gemini Proでの詳細情報抽出
- **構造化出力**: JSON形式での一貫したデータ出力
- **項目別抽出**: 案件・人材それぞれの専用抽出ロジック
- **品質検証**: 抽出結果の自動検証・補正

### **Day 34-35: データ構造化・検証**

#### **JSON出力標準化**
- **スキーマ定義**: 出力JSONの厳密な構造定義
- **バリデーション**: 出力データの形式・内容検証
- **エラー処理**: 不正な出力への対応・修正
- **後処理**: データクリーニング・正規化処理

#### **データ品質管理**
- **信頼度評価**: 抽出データの品質評価システム
- **不整合検出**: データ間の矛盾・不整合の検出
- **補完処理**: 不足データの推定・補完
- **品質スコア**: 総合的なデータ品質の数値化

### **Week 5の成果物と検証**
- **高精度AI解析**: 70%以上の抽出精度達成
- **効率的な処理**: コスト効率の良い2段階処理
- **安定した出力**: 一貫性のある構造化データ
- **品質保証**: 自動品質管理システム

---

## **ステップ6: AI解析完成・統合テスト**

### **目標**
AI解析システムの完成と全体システムの統合。Phase 1の最終検証。

### **Day 36-38: 高度な解析機能**

#### **メール前処理高度化**
- **HTML解析**: 複雑なHTMLメールの適切な処理
- **表形式データ抽出**: HTMLテーブルからの情報抽出
- **画像OCR**: 画像内テキストの読み取り（将来拡張）
- **PDF処理**: 添付PDFからの情報抽出（将来拡張）

#### **コンテキスト理解向上**
- **メール連鎖解析**: 返信・転送メールの関連性理解
- **企業情報活用**: 送信者企業情報による精度向上
- **業界知識統合**: SES業界特有の用語・慣習の理解
- **時系列分析**: メール送信時期による情報補完

### **Day 39-40: データ保存・管理**

#### **Project/Engineerテーブル実装**
- **完全なスキーマ**: 全項目を網羅したテーブル設計
- **JSON活用**: 柔軟な情報保存のためのJSON型活用
- **インデックス最適化**: 高速検索のための最適化
- **データ整合性**: 厳密な制約による品質保証

#### **手動修正機能基盤**
- **編集インターフェース**: 直感的なデータ編集機能
- **変更履歴管理**: 修正内容の完全な履歴保存
- **承認ワークフロー**: データ品質管理のための承認機能
- **学習データ蓄積**: 人間の修正を学習データとして活用

### **Day 41-42: 統合テスト・最終検証**

#### **エンドツーエンドテスト**
- **全機能統合テスト**: Gmail取得からDB保存までの完全テスト
- **大量データ処理**: 実際の運用を想定したストレステスト
- **エラー回復テスト**: 様々な障害状況での回復能力確認
- **パフォーマンステスト**: 応答時間・スループットの測定

#### **品質評価・改善**
- **精度測定**: 実際のメールデータでの精度評価
- **コスト分析**: AI API使用コストの詳細分析
- **処理速度最適化**: ボトルネック特定・改善
- **最終調整**: プロンプト・パラメータの最終最適化

### **Week 6の成果物と検証**
- **完成したAI解析システム**: 実用レベルの高精度解析
- **統合されたシステム**: Gmail→AI→DBの完全自動化
- **品質保証システム**: 継続的な品質管理機能
- **運用レディ**: 本格運用に耐える安定性・性能

---

## 🎯 Phase 1 成功基準と評価方法

### **定量的成功基準**

#### **Gmail API連携**
- **取得成功率**: 95%以上のメール取得成功率
- **処理速度**: 1メールあたり平均5秒以内の処理
- **API制限**: 日次クォータの80%以内での運用
- **安定性**: 24時間の連続稼働でエラー率5%以下

#### **AI解析精度**
- **関連性判定**: 90%以上の正確な関連性判定
- **情報抽出精度**: 70%以上の正確な情報抽出
- **構造化成功率**: 95%以上の有効なJSON出力
- **処理コスト**: 1メールあたり平均10円以下

#### **システム性能**
- **処理能力**: 1日500件以上のメール処理
- **データベース**: 99.9%の可用性
- **応答時間**: 管理画面の3秒以内の応答
- **メモリ使用量**: サーバーリソースの効率的利用

### **定性的成功基準**

#### **ユーザビリティ**
- **直感的な操作**: 技術知識なしでの基本操作
- **エラー理解**: 分かりやすいエラーメッセージ
- **処理状況**: 現在の処理状況の明確な表示
- **データ確認**: 抽出されたデータの簡単な確認

#### **運用性**
- **監視機能**: システム状態の完全な可視化
- **保守性**: エラー発生時の迅速な対応
- **拡張性**: 将来の機能追加への対応
- **セキュリティ**: 個人情報の適切な保護

---

## ⚠️ リスク管理と対応策

### **技術的リスク**

#### **Gmail API制限**
- **リスク**: API制限による処理停止
- **対策**: バッチサイズ調整、処理間隔最適化
- **緊急対応**: 手動メールアップロード機能

#### **AI解析精度不足**
- **リスク**: 実用レベルに達しない抽出精度
- **対策**: プロンプト改善、Gemini設定最適化
- **緊急対応**: 手動入力フォーム強化

#### **処理コスト超過**
- **リスク**: Gemini API使用料の予算超過
- **対策**: プロンプト最適化、処理効率化
- **緊急対応**: バッチ処理頻度の調整

### **運用リスク**

#### **データ品質問題**
- **リスク**: 低品質なデータの蓄積
- **対策**: 品質管理システム、手動確認フロー
- **緊急対応**: データクリーニング機能

#### **システム障害**
- **リスク**: 長時間のサービス停止
- **対策**: 監視・アラート機能、自動復旧
- **緊急対応**: 手動復旧手順の整備

---

## 📊 Phase 1完了時の達成状況

### **システム機能**
- ✅ **完全自動化**: Gmail→AI解析→DB保存の無人運用
- ✅ **高精度処理**: 実用レベルの情報抽出精度
- ✅ **安定稼働**: 24時間365日の継続処理
- ✅ **品質管理**: 自動品質チェック・手動修正機能

### **技術基盤**
- ✅ **認証システム**: 安全なGoogle OAuth認証
- ✅ **データベース**: 高性能・高可用性DB
- ✅ **API統合**: Gmail・Gemini APIの安定連携
- ✅ **監視システム**: 包括的なシステム監視

### **運用準備**
- ✅ **管理画面**: 直感的な操作・監視インターフェース
- ✅ **エラー処理**: 堅牢なエラーハンドリング
- ✅ **ログ機能**: 詳細な処理ログ・監査証跡
- ✅ **セキュリティ**: 本番レベルのセキュリティ対策

Phase 1完了により、**技術的実現可能性が完全に証明**され、残りのフェーズは**確実性を持って進行**できる状態となります。